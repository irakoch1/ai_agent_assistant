# Личный Telegram-планировщик событий

## Описание проекта

Это интеллектуальный Telegram-бот, который использует искусственный интеллект для автоматического планирования событий на основе естественного языка. Бот способен распознавать и планировать события, установленные пользователем в свободной форме, а также создавать долгосрочные планы на основе поставленных целей.

## Особенности

- **Планирование событий по естественному языку**: Пользователь может вводить сообщения вроде "завтра встреча в 15:00" или "послезавтра нужно помедитировать", и бот автоматически распознает и планирует это событие.
- **Глобальные цели и планы**: Возможность устанавливать долгосрочные цели (например, "выучить 100 английских слов за 30 дней") и получать автоматически сгенерированный план.
- **Анализ естественного языка**: Использование LLM (Large Language Model) для извлечения информации о событиях из текста.
- **Автоматические уведомления**: 
  - Ежедневное расписание в 10:00 утра
  - Напоминания за час до каждого события (только для событий с временем)
- **Управление расписанием**: Просмотр, обновление и удаление событий
- **Управление целями**: Установка, редактирование и отслеживание целей
- **Хранение данных**: Использование PostgreSQL для хранения данных пользователей и событий

## Технологии

- Python 3.13
- Telegram Bot API
- DeepSeek API (или другой LLM API)
- PostgreSQL
- APScheduler (для планирования задач)
- Pydantic (для валидации данных)
- Requests (для HTTP-запросов)
- Flask (для health check)

## Установка и запуск

### Требования

- Python 3.10+
- PostgreSQL

### Зависимости Python

- python-telegram-bot
- psycopg2-binary
- pydantic
- apscheduler
- requests
- python-dotenv
- flask

### Установка

1. Клонируйте репозиторий:

```bash
git clone <repository-url>
```

2. Установите зависимости:

```bash
pip install python-telegram-bot psycopg2-binary pydantic apscheduler requests python-dotenv flask
```

3. Создайте файл `.env` и укажите следующие переменные:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
DB_HOST=localhost
DB_PORT=5432
DB_NAME=имя_бд
DB_USER=имя_пользователя
DB_PASSWORD=пароль
LLM_API_KEY=ваш_API_ключ
LLM_API_URL=https://api.deepseek.com/v1/chat/completions
LLM_MODEL=deepseek-chat
DATABASE_URL=postgresql://user:password@host:port/dbname
```

4. Создайте необходимые таблицы в базе данных (см. `database.py` для структуры таблиц).

5. Запустите бота:

```bash
python main.py
```

## Использование

### Команды бота

- `/start` - начать работу с ботом
- `/goal` - установить глобальную цель
- `/clear` - очистить все события в расписании
- `/debug` - команда отладки (для разработчиков)

### Функции

1. **Добавление событий**:
   - "запланируй встречу завтра в 15"
   - "сегодня в 19.00 пробежка"
   - "завтра нужно помедитировать"
   - "послезавтра надо почитать книгу"

2. **Установка цели**:
   - `/goal выучить 100 английских слов за 30 дней`

3. **Просмотр расписания**:
   - Используйте кнопку "Посмотреть расписание"

4. **Удаление событий**:
   - "удали пробежка завтра"

5. **Очистка расписания**:
   - `/clear` или кнопка "Очистить"

## Структура проекта

```
├── main.py          # Основной файл бота
├── config.py        # Конфигурационные параметры
├── database.py      # Работа с базой данных
├── llm_client.py    # Взаимодействие с LLM
├── models.py        # Модели данных
├── scheduler.py     # Планировщик уведомлений
├── .env             # Переменные окружения
└── README.md        # Документация
```

## Архитектура

- `main.py`: Основной файл, содержащий обработчики сообщений и команд Telegram-бота
- `config.py`: Хранит конфигурационные параметры из переменных окружения
- `database.py`: Класс для работы с PostgreSQL, содержит методы для сохранения и извлечения событий
- `llm_client.py`: Класс для взаимодействия с LLM API, извлечения информации из текста и генерации ответов
- `models.py`: Pydantic модели для валидации данных
- `scheduler.py`: Класс для планирования уведомлений и напоминаний
- `.env`: Файл с секретами и конфигурацией (не должен быть выложен в репозиторий)

## Функциональные возможности

- **Извлечение информации**: Использование LLM для извлечения структурированной информации из естественного языка
- **Обработка дат и времени**: Автоматическое распознавание дат ("сегодня", "завтра", "послезавтра") и времени
- **Генерация планов**: Создание пошаговых планов для достижения целей на основе LLM
- **Управление конфликтами**: Проверка на конфликты времени (временно отключена)
- **Уведомления**: Отправка ежедневных расписаний и напоминаний
- **Управление целями**: Установка и отслеживание долгосрочных целей

## API LLM

Проект использует API искусственного интеллекта (в текущей конфигурации - DeepSeek), который позволяет:
- Извлекать информацию из текста
- Генерировать планы для достижения целей
- Создавать естественные ответы на действия пользователя

## Безопасность

- Все чувствительные данные хранятся в файле `.env`
- Используется SSL-подключение к базе данных при работе с облачными провайдерами
- Все SQL-запросы используют параметризованные выражения для предотвращения SQL-инъекций

## Автор

Разработан как часть проекта "Аналитик 3.0"

## Тестирование

В проекте есть несколько тестовых файлов для проверки различных аспектов работы бота:

- `test_schedule.py` - проверка отображения расписания
- `test_event_creation.py` - проверка создания событий
- `test_optional_time.py` - проверка создания событий с опциональным временем

Для запуска тестов:

```bash
python test_event_creation.py
python test_schedule.py
python test_optional_time.py
```
